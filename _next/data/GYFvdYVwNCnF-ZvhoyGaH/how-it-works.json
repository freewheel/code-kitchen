{"pageProps":{"source":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      h1: \"h1\",\n      p: \"p\",\n      a: \"a\",\n      code: \"code\",\n      h2: \"h2\",\n      pre: \"pre\",\n      em: \"em\",\n      strong: \"strong\",\n      ul: \"ul\",\n      li: \"li\",\n      h3: \"h3\",\n      h4: \"h4\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.h1, {\n        children: \"How in browser bundler works?\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"The core of the in-browser bundler is \", _jsx(_components.a, {\n          href: \"https://esbuild.github.io/api/#running-in-the-browser\",\n          children: \"esbuild-wasm\"\n        }), \". We also implemented a custom plugin to resolve CSS files, relative files etc.\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"You can checkout the source code at \", _jsx(_components.code, {\n          children: \"packages/src/bundle.ts\"\n        }), \".\"]\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"Resolve & transpile files\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Each playground file is virtually represented by the following interface:\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-ts\",\n          children: \"export interface PlaygroundInputFile {\\n  filename: string;\\n  code: string;\\n}\\n\"\n        })\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"Bundling these files is starting from the \", _jsx(_components.em, {\n          children: \"entrypoint file\"\n        }), \", which is the first one if there are multiple files. An entrypoint file for a playground \", _jsx(_components.strong, {\n          children: \"is a jsx/tsx module that has a default export and the default export is a React function component\"\n        }), \".\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"During bundling, esbuild will traverse the module tree and resolve all the import paths.\"\n      }), \"\\n\", _jsxs(_components.ul, {\n        children: [\"\\n\", _jsxs(_components.li, {\n          children: [\"relative paths: if a file starts with \", _jsx(_components.code, {\n            children: \"./\"\n          }), \", we believe it is a virtual relative file that can be found in the inputs. These files will be transpiled and concatenated into the final bundling result.\"]\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [\"external identifiers: all other imports are considered as external dependencies. Eg., Material UI & React, etc. These imports will leave as is in the final bundling result as \", _jsx(_components.code, {\n            children: \"require()\"\n          }), \" calls.\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"esbuild can transpile common \", _jsx(_components.a, {\n          href: \"https://esbuild.github.io/content-types/\",\n          children: \"React related modules by default\"\n        }), \", including \", _jsx(_components.code, {\n          children: \"jsx\"\n        }), \", \", _jsx(_components.code, {\n          children: \"tsx\"\n        }), \", \", _jsx(_components.code, {\n          children: \"json\"\n        }), \" etc. For CSS, we need to have some special handling, otherwise the styles will pollute the components outside of preview.\"]\n      }), \"\\n\", _jsx(_components.h3, {\n        children: \"Scoped, global CSS and CSS Modules\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"In Code Kitchen, we allow three types of CSS files for playground. By default, rules in a CSS file is scoped to the current preview. We also enabled Global and CSS Modules support with \", _jsx(_components.code, {\n          children: \".global.css\"\n        }), \" and \", _jsx(_components.code, {\n          children: \".module.css\"\n        }), \" extensions.\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"For all of the modes, we will use a \", _jsx(_components.a, {\n          href: \"https://webpack.js.org/loaders/style-loader/\",\n          children: \"style-loader\"\n        }), \" approach that injects the transpiled CSS to the DOM.\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"For scoped & CSS Modules, we also relied on \", _jsx(_components.a, {\n          href: \"https://github.com/thysultan/stylis.js\",\n          children: \"stylis\"\n        }), \" to transpile CSS along with esbuild, which is a CSS preprocessor that we can hack into the intermediate CSS AST for rules and declarations.\"]\n      }), \"\\n\", _jsx(_components.h4, {\n        children: \"Global CSS\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"Rules with \", _jsx(_components.code, {\n          children: \"global.css\"\n        }), \" will be simply applied globally even outside of the preview.\"]\n      }), \"\\n\", _jsx(_components.h4, {\n        children: \"Scoped CSS\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"Rules in a normal css without special extension will be wrapped with a random class name, and the same class name will be used to wrap the playground preview in a \", _jsx(_components.code, {\n          children: \"div\"\n        }), \" element.\"]\n      }), \"\\n\", _jsx(_components.h4, {\n        children: \"CSS Module\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"CSS file ends with \", _jsx(_components.code, {\n          children: \"module.css\"\n        }), \" will be treated as CSS modules. @\", _jsx(_components.a, {\n          href: \"https://twitter.com/evanwallace\",\n          children: \"evanw\"\n        }), \" said he wants to use \", _jsx(_components.a, {\n          href: \"https://github.com/evanw/esbuild/issues/20\",\n          children: \"\\\"CSS module bundling part of esbuild MVP\\\"\"\n        }), \", but it did not happen yet. We attempted to use PostCSS to transpile CSS Module as well, but it seems it is not supported to be run in the browser. As a result, we implement a sub-set of CSS module on our own with \", _jsx(_components.a, {\n          href: \"https://github.com/thysultan/stylis.js\",\n          children: \"stylis\"\n        }), \".\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"Typically, what we need to do for a \", _jsx(_components.code, {\n          children: \"module.css\"\n        }), \" file:\"]\n      }), \"\\n\", _jsxs(_components.ul, {\n        children: [\"\\n\", _jsx(_components.li, {\n          children: \"add a prefix to every class name in the CSS\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"transpile the CSS into a JS object that is a mapping from original class name to the actual prefixed class name\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"This turns out to be straightforward with stylis:\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-js\",\n          children: \"function compileCssModule(css: string, buildId: string) {\\n  const classMapping = {};\\n  const res = serialize(\\n    compile(css),\\n    middleware([\\n      (element) => {\\n        if (element.length > -1) {\\n          if (element.type === RULESET && element.props) {\\n            element.props = (\\n              Array.isArray(element.props)\\n                ? [...element.props]\\n                : [element.props]\\n            ).map((prop) => {\\n              return prop.replaceAll(/\\\\.-?[_a-zA-Z]+[_a-zA-Z0-9-]*/g, (m) => {\\n                const varName = m.slice(1);\\n                if (!classMapping[varName]) {\\n                  classMapping[varName] = varName + \\\"_\\\" + buildId;\\n                }\\n                return \\\".\\\" + classMapping[varName];\\n              });\\n            });\\n          }\\n        }\\n      },\\n      stringify,\\n    ])\\n  );\\n\\n  return {\\n    contents: `${injectCSS(res, buildId)}\\n    export default ${JSON.stringify(classMapping)}`,\\n  };\\n}\\n\"\n        })\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"Eval and Rendering the Preview\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Now that all playground are bundled in a single large string, which is a common js module that its default export is the latest demo React function component. E.g., the following input playground file\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-md\",\n          children: \"```js\\nimport { Button } from \\\"my-private-button-lib\\\";\\nimport \\\"./styles.css\\\";\\n\\nexport default function Demo() {\\n  return <Button>Button</Button>;\\n}\\n```\\n\\n```css styles.css\\nbutton {\\n  width: 200px;\\n}\\n```\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Will be bundled as\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-js\",\n          children: \"var __create = Object.create;\\nvar __defProp = Object.defineProperty;\\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\\nvar __getOwnPropNames = Object.getOwnPropertyNames;\\nvar __getProtoOf = Object.getPrototypeOf;\\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\\nvar __markAsModule = (target) =>\\n  __defProp(target, \\\"__esModule\\\", { value: true });\\nvar __export = (target, all) => {\\n  for (var name in all)\\n    __defProp(target, name, { get: all[name], enumerable: true });\\n};\\nvar __reExport = (target, module2, copyDefault, desc) => {\\n  if (\\n    (module2 && typeof module2 === \\\"object\\\") ||\\n    typeof module2 === \\\"function\\\"\\n  ) {\\n    for (let key of __getOwnPropNames(module2))\\n      if (!__hasOwnProp.call(target, key) && (copyDefault || key !== \\\"default\\\"))\\n        __defProp(target, key, {\\n          get: () => module2[key],\\n          enumerable:\\n            !(desc = __getOwnPropDesc(module2, key)) || desc.enumerable,\\n        });\\n  }\\n  return target;\\n};\\nvar __toESM = (module2, isNodeMode) => {\\n  return __reExport(\\n    __markAsModule(\\n      __defProp(\\n        module2 != null ? __create(__getProtoOf(module2)) : {},\\n        \\\"default\\\",\\n        !isNodeMode && module2 && module2.__esModule\\n          ? { get: () => module2.default, enumerable: true }\\n          : { value: module2, enumerable: true }\\n      )\\n    ),\\n    module2\\n  );\\n};\\nvar __toCommonJS = /* @__PURE__ */ ((cache) => {\\n  return (module2, temp) => {\\n    return (\\n      (cache && cache.get(module2)) ||\\n      ((temp = __reExport(__markAsModule({}), module2, 1)),\\n      cache && cache.set(module2, temp),\\n      temp)\\n    );\\n  };\\n})(typeof WeakMap !== \\\"undefined\\\" ? /* @__PURE__ */ new WeakMap() : 0);\\n\\n// playground-input:App.jsx\\nvar App_exports = {};\\n__export(App_exports, {\\n  default: () => Demo,\\n});\\n\\n// playground-input:styles.css\\n(function () {\\n  const style = document.createElement(\\\"style\\\");\\n  style.innerHTML = \\\".esscu button{width:200px;}\\\";\\n  style.setAttribute(\\\"data-playground-style-id\\\", \\\"esscu\\\");\\n  document.head.appendChild(style);\\n})();\\n\\n// playground-input:App.jsx\\nvar import_private_button_lib = __toESM(require(\\\"my-private-button-lib\\\"));\\nfunction Demo() {\\n  return /* @__PURE__ */ React.createElement(\\n    import_private_button_lib.Button,\\n    null,\\n    \\\"Button\\\"\\n  );\\n}\\nmodule.exports = __toCommonJS(App_exports);\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"To render it, we need to:\"\n      }), \"\\n\", _jsxs(_components.ul, {\n        children: [\"\\n\", _jsx(_components.li, {\n          children: \"evaluate the module and get the default export\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"if necessary, provide external dependencies\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"The above module will be wrapped as \", _jsx(_components.code, {\n          children: \"((require, module) => { ... content }))(require, module)\"\n        }), \" using \", _jsx(_components.code, {\n          children: \"new Function\"\n        }), \" and then evaluate. Note we passed in two external variables, which is \", _jsx(_components.code, {\n          children: \"require\"\n        }), \" and \", _jsx(_components.code, {\n          children: \"module\"\n        }), \".\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"You can see in the bundled code there is a \", _jsx(_components.code, {\n          children: \"require('my-private-button-lib')\"\n        }), \" call, which is the CJS version of \", _jsx(_components.code, {\n          children: \"import 'my-private-button-lib'\"\n        }), \". Thus, we can provide a customized \", _jsx(_components.code, {\n          children: \"require\"\n        }), \" to inject external modules.\"]\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-js\",\n          children: \"import * as privateLib from \\\"my-private-button-lib\\\";\\n// ...\\n\\nconst dependencies = {\\n  \\\"my-private-button-lib\\\": privateLib,\\n  // ...\\n};\\n\\nfunction require(key) {\\n  return dependencies[key];\\n}\\n\"\n        })\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"After the bundled CJS module is evaluated, we then get the function component at \", _jsx(_components.code, {\n          children: \"module.exports.default\"\n        }), \" and then render it to the preview panel.\"]\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true}